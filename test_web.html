<!DOCTYPE html>
<html>
<head>
    <title>NCALayer Mock Test</title>
</head>
<body>
    <h1>NCALayer Python Mock Test</h1>
    
    <button onclick="testConnection()">Test Connection</button>
    <button onclick="testSign()">Test Sign</button>
    
    <div id="output" style="margin-top: 20px; white-space: pre-wrap;"></div>

    <script>
        class NCALayerMockClient {
            constructor() {
                this.ws = null;
                this.output = document.getElementById('output');
            }
            
            log(message) {
                this.output.textContent += message + '\n';
            }
            
            async connect() {
                try {
                    this.ws = new WebSocket('ws://127.0.0.1:13579');
                    
                    return new Promise((resolve, reject) => {
                        this.ws.onopen = () => {
                            this.log('Connected to Python mock server');
                            resolve();
                        };
                        
                        this.ws.onerror = (error) => {
                            this.log('Connection error: ' + error);
                            reject(error);
                        };
                    });
                } catch (error) {
                    this.log('WebSocket error: ' + error);
                }
            }
            
            async sendRequest(request) {
                if (!this.ws) await this.connect();
                
                return new Promise((resolve, reject) => {
                    this.ws.onmessage = (event) => {
                        resolve(JSON.parse(event.data));
                    };
                    
                    this.ws.onerror = (error) => reject(error);
                    this.ws.send(JSON.stringify(request));
                });
            }
            
            async getVersion() {
                const request = {
                    module: 'kz.gov.pki.knca.commonUtils',
                    method: 'getVersion'
                };
                
                return await this.sendRequest(request);
            }
            
            async signData(data) {
                const request = {
                    module: 'kz.gov.pki.knca.basics',
                    method: 'sign',
                    args: {
                        format: 'cms',
                        data: btoa(data),
                        signingParams: { detached: true },
                        signerParams: {},
                        locale: 'ru'
                    }
                };
                
                return await this.sendRequest(request);
            }
        }
        
        const client = new NCALayerMockClient();
        
        async function testConnection() {
            try {
                const version = await client.getVersion();
                client.log('Version: ' + JSON.stringify(version, null, 2));
            } catch (error) {
                client.log('Error: ' + error);
            }
        }
        
        async function testSign() {
            try {
                const signature = await client.signData('Test data from browser');
                client.log('Signature: ' + JSON.stringify(signature, null, 2));
            } catch (error) {
                client.log('Error: ' + error);
            }
        }
    </script>
</body>
</html>
